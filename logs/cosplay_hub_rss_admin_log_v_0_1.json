{
  "meta": {
    "project": "CosplayHub – RSS & Admin Pipeline",
    "scope": "Up to /review card (no inline buttons handling)",
    "date": "2025-11-25",
    "language": "en"
  },
  "db": {
    "schema_version": "MVP v0.1 (subset)",
    "tables": {
      "source": {
        "description": "Content sources (RSS etc.)",
        "columns": {
          "id": "bigint PK",
          "source_key": "text, unique, human-readable key used in upsert",
          "name": "text, display name of source",
          "type": "enum source_type, e.g. 'rss'",
          "url": "text, RSS feed URL",
          "default_language": "text, e.g. 'en'",
          "default_geo_tags": "text[] (not actively used yet in this chat)",
          "default_topic_tags": "text[] (not actively used yet in this chat)",
          "fetch_interval_minutes": "integer, polling interval",
          "is_active": "boolean, whether used by ingestion",
          "last_fetched_at": "timestamptz, last RSS fetch time",
          "last_fetch_status": "text, last fetch status",
          "config": "jsonb, reserved",
          "created_at": "timestamptz",
          "updated_at": "timestamptz",
          "content_type": "enum content_type, e.g. tutorial/news/event/profile/announcement/other"
        },
        "indexes": [
          "UNIQUE (source_key)"
        ]
      },
      "content_item": {
        "description": "Normalized content entries produced from sources",
        "columns": {
          "id": "bigint PK",
          "source_id": "bigint FK -> source.id",
          "title": "text",
          "original_url": "text",
          "status": "enum content_status (new/ready_for_review/approved/posted/archived/...), used in review flow",
          "content_type": "enum content_type (tutorial/news/event/profile/announcement/other)",
          "data": "jsonb, raw+normalized payload",
          "published_at": "timestamptz, original publication date (used in review card)",
          "created_at": "timestamptz",
          "updated_at": "timestamptz",
          "posted_to_channel": "boolean",
          "posted_at": "timestamptz",
          "posted_telegram_message_id": "text (optional)"
        }
      }
    }
  },
  "workflows": [
    {
      "name": "RSS – Ingest active sources to content_item",
      "type": "n8n workflow",
      "status": "implemented earlier in this chat (summary only)",
      "description": "Periodically reads active RSS sources from table source and upserts items into content_item.",
      "nodes": [
        {
          "id": "schedule_trigger",
          "name": "Schedule Trigger",
          "type": "n8n-nodes-base.scheduleTrigger",
          "config_summary": "Runs periodically (e.g. every X minutes)."
        },
        {
          "id": "get_active_sources",
          "name": "Execute a SQL query",
          "type": "n8n-nodes-base.postgres",
          "config_summary": "SELECT * FROM public.source WHERE type='rss' AND is_active = true;"
        },
        {
          "id": "loop_over_sources",
          "name": "Loop Over Items",
          "type": "n8n-nodes-base.splitInBatches",
          "config_summary": "Iterates over active sources."
        },
        {
          "id": "rss_read_ingest",
          "name": "RSS Read",
          "type": "n8n-nodes-base.rssFeedRead",
          "config_summary": "Reads feed from current source.url, returns items."
        },
        {
          "id": "attach_source_info",
          "name": "Attach source info",
          "type": "n8n-nodes-base.code",
          "language": "JavaScript",
          "code_lines": [
            "// Shape: items from RSS plus source.* from loop",
            "// Adds source_id/source_key/content_type/etc. into each item before mapping to content_item."
          ]
        },
        {
          "id": "map_to_content_item",
          "name": "Map to content_item",
          "type": "n8n-nodes-base.code",
          "language": "JavaScript",
          "code_lines": [
            "// Takes rss+source combined item and maps to content_item fields:",
            "// title, original_url, source_id, content_type, status='new' or 'ready_for_review',",
            "// data (json with raw rss), published_at, etc."
          ]
        },
        {
          "id": "upsert_content_item",
          "name": "Insert or update rows (content_item)",
          "type": "n8n-nodes-base.postgres",
          "config_summary": "Upserts into public.content_item based on unique constraint (e.g. source_id + original_url or external id)."
        }
      ],
      "edges": [
        ["schedule_trigger", "get_active_sources"],
        ["get_active_sources", "loop_over_sources"],
        ["loop_over_sources", "rss_read_ingest"],
        ["rss_read_ingest", "attach_source_info"],
        ["attach_source_info", "map_to_content_item"],
        ["map_to_content_item", "upsert_content_item"]
      ]
    },
    {
      "name": "Content – Post approved content_item to Telegram channel",
      "type": "n8n workflow",
      "status": "implemented earlier (summary only)",
      "description": "Selects approved, not-posted content_item rows, formats message and sends to public CosplayHub channel, then marks them as posted.",
      "nodes": [
        {
          "id": "schedule_trigger_post",
          "name": "Schedule Trigger",
          "type": "n8n-nodes-base.scheduleTrigger"
        },
        {
          "id": "select_approved_items",
          "name": "Execute a SQL query",
          "type": "n8n-nodes-base.postgres",
          "config_summary": "SELECT * FROM public.content_item WHERE status='approved' AND posted_to_channel = false ORDER BY updated_at ASC LIMIT N;"
        },
        {
          "id": "loop_over_items_post",
          "name": "Loop Over Items",
          "type": "n8n-nodes-base.splitInBatches"
        },
        {
          "id": "send_to_channel",
          "name": "Telegram – Send a text message",
          "type": "n8n-nodes-base.telegram",
          "config_summary": "Uses bot for public channel, formats title + date + URL; removed n8n branding via Parse Mode / text setup."
        },
        {
          "id": "mark_posted",
          "name": "Execute a SQL query",
          "type": "n8n-nodes-base.postgres",
          "config_summary": "UPDATE public.content_item SET status='posted', posted_to_channel=true, posted_at=NOW() WHERE id = {{ $json.id }};"
        }
      ],
      "edges": [
        ["schedule_trigger_post", "select_approved_items"],
        ["select_approved_items", "loop_over_items_post"],
        ["loop_over_items_post", "send_to_channel"],
        ["send_to_channel", "mark_posted"]
      ]
    },
    {
      "name": "Admin – Telegram Router (support bot @CosplayHubContMan_bot)",
      "type": "n8n workflow",
      "status": "detailed; includes /addsource AI onboarding + /review text card (no callback processing yet)",
      "nodes": [
        {
          "id": "telegram_trigger_admin",
          "name": "Telegram Trigger",
          "type": "n8n-nodes-base.telegramTrigger",
          "config": {
            "bot": "@CosplayHubContMan_bot",
            "triggerOn": "Message",
            "restrictToChatIds": ["<ADMIN_CHAT_ID>"]
          }
        },
        {
          "id": "parse_command",
          "name": "Parse Command",
          "type": "n8n-nodes-base.code",
          "language": "JavaScript",
          "code_lines": [
            "// Expects Telegram Trigger output; extracts /addsource <url> only.",
            "return items",
            "  .map(item => {",
            "    const msg = item.json.message || item.json.edited_message || null;",
            "    if (!msg) return null;",
            "    const text = (msg.text || '').trim();",
            "    const chat = msg.chat || {};",
            "    const from = msg.from || {};",
            "    if (!text.toLowerCase().startsWith('/addsource')) return null;",
            "    const parts = text.split(/\\s+/);",
            "    const url = parts[1] || '';",
            "    return {",
            "      json: {",
            "        raw_text: text,",
            "        source_url: url,",
            "        chat_id: chat.id,",
            "        chat_title: chat.title || chat.username || '',",
            "        user_id: from.id,",
            "        user_name: from.username || `${from.first_name || ''} ${from.last_name || ''}`.trim()",
            "      }",
            "    };",
            "  })",
            "  .filter(item => item !== null);"
          ]
        },
        {
          "id": "build_source_draft",
          "name": "Build Source Draft",
          "type": "n8n-nodes-base.code",
          "language": "JavaScript",
          "code_lines": [
            "function makeSourceKey(url) {",
            "  let u = url.trim().toLowerCase();",
            "  u = u.replace(/^https?:\\/\\//, '');",
            "  u = u.replace(/\\/+$\\/, '');",
            "  const parts = u.split('\\/');",
            "  const domain = parts[0] || '';",
            "  const firstPath = parts[1] || '';",
            "  let key = domain;",
            "  if (firstPath) key += '-' + firstPath;",
            "  key = key.replace(/[^a-z0-9]+/g, '_');",
            "  key = key.replace(/_+/g, '_').replace(/^_+|_+$/g, '');",
            "  if (!key) key = 'source_' + Date.now();",
            "  return key;",
            "}",
            "",
            "return items.map(item => {",
            "  const data = item.json;",
            "  const url = (data.source_url || '').trim();",
            "  const sourceKey = makeSourceKey(url);",
            "  const defaultName = `Source ${sourceKey}`;",
            "  return {",
            "    json: {",
            "      raw_text: data.raw_text,",
            "      chat_id: data.chat_id,",
            "      chat_title: data.chat_title,",
            "      user_id: data.user_id,",
            "      user_name: data.user_name,",
            "      source_url: url,",
            "      source_key: sourceKey,",
            "      name: defaultName,",
            "      type: 'rss',",
            "      default_language: 'en',",
            "      default_geo_tags: ['global'],",
            "      default_topic_tags: [],",
            "      fetch_interval_minutes: 60,",
            "      is_active: false,",
            "      content_type: 'news'",
            "    }",
            "  };",
            "});"
          ]
        },
        {
          "id": "upsert_source",
          "name": "Upsert Source",
          "type": "n8n-nodes-base.postgres",
          "sql_lines": [
            "INSERT INTO public.source",
            "(",
            "    source_key,",
            "    name,",
            "    type,",
            "    url,",
            "    default_language,",
            "    fetch_interval_minutes,",
            "    is_active,",
            "    content_type",
            ")",
            "VALUES",
            "(",
            "    '{{{{$json[\"source_key\"]}}}}',",
            "    '{{{{$json[\"name\"]}}}}',",
            "    '{{{{$json[\"type\"]}}}}',",
            "    '{{{{$json[\"source_url\"]}}}}',",
            "    '{{{{$json[\"default_language\"]}}}}',",
            "    {{{{$json[\"fetch_interval_minutes\"]}}}},",
            "    {{{{$json[\"is_active\"]}}}},",
            "    '{{{{$json[\"content_type\"]}}}}'",
            ")",
            "ON CONFLICT (source_key)",
            "DO UPDATE SET",
            "    name = EXCLUDED.name,",
            "    type = EXCLUDED.type,",
            "    url = EXCLUDED.url,",
            "    default_language = EXCLUDED.default_language,",
            "    fetch_interval_minutes = EXCLUDED.fetch_interval_minutes,",
            "    is_active = EXCLUDED.is_active,",
            "    content_type = EXCLUDED.content_type",
            "RETURNING id, source_key, name;"
          ]
        },
        {
          "id": "load_source_for_ai",
          "name": "Load Source For AI",
          "type": "n8n-nodes-base.postgres",
          "sql_lines": [
            "SELECT",
            "  id,",
            "  source_key,",
            "  name,",
            "  type,",
            "  url,",
            "  default_language,",
            "  fetch_interval_minutes,",
            "  is_active,",
            "  content_type",
            "FROM public.source",
            "WHERE source_key = '{{{{$item(0).$node[\"Upsert Source\"].json[\"source_key\"]}}}}';"
          ]
        },
        {
          "id": "rss_read_ai_preview",
          "name": "RSS Read (AI Source Preview)",
          "type": "n8n-nodes-base.rssFeedRead",
          "config_summary": "URL expression: {{$json[\"url\"]}}, limit ≈ 5–10 items."
        },
        {
          "id": "build_ai_payload",
          "name": "Build AI Payload",
          "type": "n8n-nodes-base.code",
          "language": "JavaScript",
          "code_lines": [
            "const source = $item(0).$node[\"Load Source For AI\"].json;",
            "if (!source) return [];",
            "const maxSamples = 5;",
            "const samples = items.slice(0, maxSamples).map(item => {",
            "  const rss = item.json;",
            "  return {",
            "    title: rss.title || '',",
            "    description: rss.contentSnippet || rss.description || '',",
            "    link: rss.link || '',",
            "    pubDate: rss.pubDate || rss.isoDate || null",
            "  };",
            "});",
            "return [",
            "  {",
            "    json: {",
            "      source_id: source.id,",
            "      source_key: source.source_key,",
            "      url: source.url,",
            "      current_config: {",
            "        name: source.name,",
            "        default_language: source.default_language,",
            "        content_type: source.content_type,",
            "        fetch_interval_minutes: source.fetch_interval_minutes,",
            "        is_active: source.is_active",
            "      },",
            "      samples",
            "    }",
            "  },",
            "];"
          ]
        },
        {
          "id": "openai_chat_model",
          "name": "OpenAI Chat Model",
          "type": "n8n-nodes-base.openAiChatModel",
          "config_summary": "Model: e.g. gpt-4.1-mini/gpt-4o-mini; used as model provider for Basic LLM Chain."
        },
        {
          "id": "basic_llm_chain",
          "name": "Basic LLM Chain",
          "type": "n8n-nodes-base.basicLlmChain",
          "config": {
            "model_node": "OpenAI Chat Model",
            "source_for_prompt": "Define below",
            "prompt_expression_lines": [
              "Here is the source payload in JSON:",
              "", 
              "{{ JSON.stringify($json) }}"
            ],
            "chat_messages": [
              {
                "role": "system",
                "message_lines": [
                  "You are a content classification assistant for a cosplay news hub for Finland and the Nordics.",
                  "You receive JSON describing an RSS source and a few of its recent posts.",
                  "Your task is to propose a clean, structured configuration for this source.",
                  "",
                  "Return ONLY valid JSON, no explanations, no markdown.",
                  "",
                  "Fields:",
                  "- name: short human-readable source name (string)",
                  "- default_language: two-letter code, one of [\"en\",\"fi\",\"sv\",\"no\",\"da\",\"is\",\"ja\",\"other\"]",
                  "- default_geo_tags: array of strings from [\"global\",\"fi\",\"se\",\"no\",\"dk\",\"is\",\"nordics\"]",
                  "- default_topic_tags: array of strings from controlled list",
                  "- content_type: one of [\"tutorial\",\"news\",\"event\",\"profile\",\"announcement\",\"other\"]",
                  "- fetch_interval_minutes: one of [15,30,60,120,360]",
