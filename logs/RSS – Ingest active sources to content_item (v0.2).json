{
  "workflows": [
    {
      "workflow_name": "RSS ‚Äì Ingest active sources to content_item (v0.2)",
      "purpose": [
        "–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —á–∏—Ç–∞—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ RSS-–∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã source",
        "–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å RSS-items, –≤—ã–∑–≤–∞—Ç—å LLM –¥–ª—è –∫—Ä–∞—Ç–∫–æ–≥–æ summary",
        "Upsert-–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ public.content_item —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º new/ready_for_review"
      ],
      "entry": "schedule_trigger_ingest",
      "nodes": {
        "schedule_trigger_ingest": {
          "type": "schedule_trigger",
          "description": "–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ N –º–∏–Ω—É—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç).",
          "config": {
            "mode": "interval",
            "every": "N minutes"
          },
          "output": ["get_active_sources"]
        },

        "get_active_sources": {
          "type": "postgres_execute_query",
          "description": "–ë–µ—Ä—ë–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö RSS –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.",
          "connection": "Postgres account",
          "sql": "SELECT id, source_key, name, url, default_language, default_geo_tags, default_topic_tags\nFROM public.source\nWHERE type = 'rss' AND is_active = true;",
          "output": ["loop_over_sources"]
        },

        "loop_over_sources": {
          "type": "split_in_batches",
          "description": "–ü–µ—Ä–µ–±–∏—Ä–∞–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ –æ–¥–Ω–æ–º—É (–∏–ª–∏ –Ω–µ–±–æ–ª—å—à–∏–º–∏ –±–∞—Ç—á–∞–º–∏).",
          "config": {
            "batchSize": 1
          },
          "output": ["rss_read_ingest"]
        },

        "rss_read_ingest": {
          "type": "rss_feed_read",
          "description": "–ß–∏—Ç–∞–µ—Ç RSS –ø–æ —Ç–µ–∫—É—â–µ–º—É source.url –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç items.",
          "config": {
            "url_expression": "{{ $json[\"url\"] }}",
            "options": {
              "parseFull": true
            }
          },
          "output": ["attach_source_info"]
        },

        "attach_source_info": {
          "type": "code",
          "language": "javascript",
          "description": "–î–æ–±–∞–≤–ª—è–µ—Ç –∫ –∫–∞–∂–¥–æ–º—É RSS item –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Å—Ç–æ—á–Ω–∏–∫–µ (source_id, source_key, –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ç–µ–≥–∏).",
          "code": "const source = $items(\"loop_over_sources\")[0].json;\n\nreturn $input.all().map(item => {\n  const rss = item.json;\n  return {\n    json: {\n      source_id: source.id,\n      source_key: source.source_key,\n      default_language: source.default_language || 'en',\n      default_geo_tags: source.default_geo_tags || [],\n      default_topic_tags: source.default_topic_tags || [],\n      rss: rss\n    }\n  };\n});",
          "output": ["build_llm_input"]
        },

        "build_llm_input": {
          "type": "code",
          "language": "javascript",
          "description": "–ì–æ—Ç–æ–≤–∏—Ç —Ç–µ–∫—Å—Ç –∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è LLM –Ω–∞ –æ—Å–Ω–æ–≤–µ RSS item.",
          "code": "return $input.all().map(item => {\n  const data = item.json;\n  const rss = data.rss;\n\n  // –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∏ –∫–∞—Ä—Ç–∏–Ω–∫—É (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)\n  const title = rss.title || '';\n  const description = (rss.contentSnippet || rss.content || '').toString();\n  let imageUrl = null;\n  if (rss.enclosure && rss.enclosure.url) imageUrl = rss.enclosure.url;\n\n  // –ø—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å <img src> –∏–∑ HTML\n  if (!imageUrl && typeof rss.content === 'string') {\n    const m = rss.content.match(/<img[^>]+src=[\"']([^\"']+)[\"']/i);\n    if (m) imageUrl = m[1];\n  }\n\n  const prompt = `${title}\\n\\n${description}`.slice(0, 4000);\n\n  return {\n    json: {\n      ...data,\n      title,\n      description,\n      image_url: imageUrl,\n      llm_prompt: prompt\n    }\n  };\n});",
          "output": ["openai_summary"]
        },

        "openai_summary": {
          "type": "openai_chat_model",
          "description": "–ö–æ—Ä–æ—Ç–∫–∏–π summary –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º (2‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).",
          "config": {
            "model": "gpt-4.1-mini (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π)",
            "system_message": "You are a content summarizer for a cosplay news channel. Summarize the article in 2-3 short sentences in English.",
            "user_message_expression": "{{ $json[\"llm_prompt\"] }}"
          },
          "output": ["map_to_content_item"]
        },

        "map_to_content_item": {
          "type": "code",
          "language": "javascript",
          "description": "–°–æ–±–∏—Ä–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã public.content_item.",
          "code": "return $input.all().map(item => {\n  const data = item.json;\n  const rss = data.rss;\n  const llm = item.$node[\"openai_summary\"].json; // summary –≤ llm.text –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–º –ø–æ–ª–µ\n\n  const summary = llm.text || llm.summary || data.description || '';\n\n  return {\n    json: {\n      source_id: data.source_id,\n      external_id: rss.guid || null,\n      title: data.title,\n      summary,\n      original_url: rss.link || null,\n      image_url: data.image_url || null,\n      content_type: 'tutorial',\n      language: data.default_language || 'en',\n      geo_tags: data.default_geo_tags || [],\n      topic_tags: data.default_topic_tags || [],\n      published_at: rss.isoDate || rss.pubDate || null,\n      status: 'new',\n      posted_to_channel: false,\n      is_manual: false,\n      is_sponsored: false,\n      raw_payload_ref: null,\n      source_metadata: {\n        rss\n      }\n    }\n  };\n});",
          "output": ["upsert_content_item"]
        },

        "upsert_content_item": {
          "type": "postgres_execute_query",
          "description": "Upsert –≤ public.content_item –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–ª—é—á–∞ (source_id + original_url –∏–ª–∏ external_id).",
          "connection": "Postgres account",
          "sql_summary": "INSERT INTO public.content_item (...) VALUES (...) ON CONFLICT (source_id, original_url) DO UPDATE SET ...; –∑–∞–ø–æ–ª–Ω—è–µ—Ç ingested_at=NOW(), updated_at=NOW()."
        }
      },
      "edges": [
        ["schedule_trigger_ingest", "get_active_sources"],
        ["get_active_sources", "loop_over_sources"],
        ["loop_over_sources", "rss_read_ingest"],
        ["rss_read_ingest", "attach_source_info"],
        ["attach_source_info", "build_llm_input"],
        ["build_llm_input", "openai_summary"],
        ["openai_summary", "map_to_content_item"],
        ["map_to_content_item", "upsert_content_item"]
      ]
    },

    {
      "workflow_name": "Content ‚Äì Post approved content_item to Telegram channel",
      "purpose": [
        "–í—ã–±—Ä–∞—Ç—å approved, –µ—â—ë –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ content_item",
        "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–π Telegram-–∫–∞–Ω–∞–ª CosplayHub",
        "–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–ø–∏—Å–∏ –∫–∞–∫ posted –≤ –ë–î"
      ],
      "entry": "schedule_trigger_post",
      "nodes": {
        "schedule_trigger_post": {
          "type": "schedule_trigger",
          "description": "–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ä–∞—Å—Å—ã–ª–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∏–ª–∏ —á–∞—Å–æ–≤).",
          "config": {
            "mode": "interval",
            "every": "N minutes/hours"
          },
          "output": ["select_approved_items"]
        },

        "select_approved_items": {
          "type": "postgres_execute_query",
          "description": "–ë–µ—Ä—ë–º –∫–æ–Ω—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—à—ë–ª —Ä–µ–≤—å—é –∏ –µ—â—ë –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞–ª—Å—è.",
          "connection": "Postgres account",
          "sql": "SELECT id, title, summary, original_url, image_url, published_at\nFROM public.content_item\nWHERE status = 'approved'::content_status\n  AND posted_to_channel = false\nORDER BY updated_at ASC\nLIMIT 20;",
          "output": ["loop_over_items_post"]
        },

        "loop_over_items_post": {
          "type": "split_in_batches",
          "description": "–ò—Ç–µ—Ä–∏—Ä—É–µ–º –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É –¥–ª—è –ø–æ—Å—Ç–∏–Ω–≥–∞, –ø–æ –æ–¥–Ω–æ–º—É item.",
          "config": {
            "batchSize": 1
          },
          "output": ["send_to_channel"]
        },

        "send_to_channel": {
          "type": "telegram_send_message",
          "description": "–ü—É–±–ª–∏–∫—É–µ—Ç –ø–æ—Å—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–π Telegram-–∫–∞–Ω–∞–ª CosplayHub (—Å —Ç–µ–∫—Å—Ç–æ–º –∏, –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏, –∫–∞—Ä—Ç–∏–Ω–∫–æ–π).",
          "config": {
            "bot_credentials": "Telegram public channel bot",
            "chat_id": "@CosplayHubChannel",
            "parse_mode": "Markdown",
            "text_expression": "üé≠ *{{ $json[\"title\"] }}*\\n\\n{{ $json[\"summary\"] }}\\n\\nüìé {{ $json[\"original_url\"] }}",
            "optional_photo_expression": "{{ $json[\"image_url\"] || '' }}"
          },
          "output": ["mark_posted"]
        },

        "mark_posted": {
          "type": "postgres_execute_query",
          "description": "–ü–æ–º–µ—á–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –∫–∞–∫ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–π.",
          "connection": "Postgres account",
          "sql": "UPDATE public.content_item\nSET status = 'posted'::content_status,\n    posted_to_channel = true,\n    posted_at = NOW(),\n    posted_message_id = $2\nWHERE id = $1::bigint;",
          "query_parameters_expression": "{{ $json[\"id\"] }},{{ $node[\"send_to_channel\"].json[\"result\"][\"message_id\"] }}"
        }
      },
      "edges": [
        ["schedule_trigger_post", "select_approved_items"],
        ["select_approved_items", "loop_over_items_post"],
        ["loop_over_items_post", "send_to_channel"],
        ["send_to_channel", "mark_posted"]
      ]
    }
  ]
}
